name: Test Validation Steps

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test-input-validation-fails:
    name: Test Input Validation Failure Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      # Missing files and file-format
      - name: Missing files and file-format
        id: missing-files-and-file-format
        uses: ./
        continue-on-error: true
        with:
          schema-file: test-files/json/person.schema.json

      # Missing schema-file and schema-url
      - name: Missing schema-file and schema-url
        id: missing-schema-file-and-schema-url
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json

      # Both schema-file and schema-url
      - name: Both schema-file and schema-url
        id: both-schema-file-and-schema-url
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-file: test-files/json/person.schema.json
          schema-url: https://example.com/schema.json
      
      # Invalid file-format option
      - name: Invalid file-format option
        id: invalid-file-format-option
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          file-format: invalid-option
          schema-file: test-files/json/person.schema.json
      
      # Invalid schema-format option
      - name: Invalid schema-format option
        id: invalid-schema-format-option
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-file: test-files/json/person.schema.json
          schema-format: invalid-option
      
      # Invalid output-format option
      - name: Invalid output-format option
        id: invalid-output-format-option
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-file: test-files/json/person.schema.json
          output-format: invalid-option
      
      - name: Collect results
        id: collect-results
        env:
          MISSING_FILES_AND_FORMAT: ${{ steps.missing-files-and-file-format.outcome }}
          MISSING_SCHEMA_FILE_AND_URL: ${{ steps.missing-schema-file-and-schema-url.outcome }}
          BOTH_SCHEMA_FILE_AND_URL: ${{ steps.both-schema-file-and-schema-url.outcome }}
          INVALID_FILE_FORMAT_OPTION: ${{ steps.invalid-file-format-option.outcome }}
          INVALID_SCHEMA_FORMAT_OPTION: ${{ steps.invalid-schema-format-option.outcome }}
          INVALID_OUTPUT_FORMAT_OPTION: ${{ steps.invalid-output-format-option.outcome }}
        run: |
          function pick_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              *) echo "❓" ;;
            esac
          }

          # Flip results, failure -> success
          [ "$MISSING_FILES_AND_FORMAT" = "failure" ] && MISSING_FILES_AND_FORMAT="success"
          [ "$MISSING_SCHEMA_FILE_AND_URL" = "failure" ] && MISSING_SCHEMA_FILE_AND_URL="success"
          [ "$BOTH_SCHEMA_FILE_AND_URL" = "failure" ] && BOTH_SCHEMA_FILE_AND_URL="success"
          [ "$INVALID_FILE_FORMAT_OPTION" = "failure" ] && INVALID_FILE_FORMAT_OPTION="success"
          [ "$INVALID_SCHEMA_FORMAT_OPTION" = "failure" ] && INVALID_SCHEMA_FORMAT_OPTION="success"
          [ "$INVALID_OUTPUT_FORMAT_OPTION" = "failure" ] && INVALID_OUTPUT_FORMAT_OPTION="success"
          
          # Show results in GitHub step summary
          echo "$(pick_emoji $MISSING_FILES_AND_FORMAT) Missing files and file-format" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $MISSING_SCHEMA_FILE_AND_URL) Missing schema-file and schema-url" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $BOTH_SCHEMA_FILE_AND_URL) Both schema-file and schema-url" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $INVALID_FILE_FORMAT_OPTION) Invalid file-format option" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $INVALID_SCHEMA_FORMAT_OPTION) Invalid schema-format option" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $INVALID_OUTPUT_FORMAT_OPTION) Invalid output-format option" >> $GITHUB_STEP_SUMMARY
          
          # Validate that all tests failed
          if [ "$MISSING_FILES_AND_FORMAT" != "success" ] || \
             [ "$MISSING_SCHEMA_FILE_AND_URL" != "success" ] || \
             [ "$BOTH_SCHEMA_FILE_AND_URL" != "success" ] || \
             [ "$INVALID_FILE_FORMAT_OPTION" != "success" ] || \
             [ "$INVALID_SCHEMA_FORMAT_OPTION" != "success" ] || \
             [ "$INVALID_OUTPUT_FORMAT_OPTION" != "success" ]; then
            echo "::error::One or more tests did not fail as expected"
            exit 1
          fi

  test-files-exist-fails:
    name: Test File Existence Failure Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false
      
      # Non-existent file
      - name: Non-existent file
        id: non-existent-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
            test-files/non-existent.json
          schema-file: test-files/json/person.schema.json
      
      # Non-existent schema
      - name: Non-existent schema file
        id: non-existent-schema-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-file: test-files/non-existent.schema.json
      
      - name: Collect results
        id: collect-results
        env:
          NON_EXISTENT_FILE: ${{ steps.non-existent-file.outcome }}
          NON_EXISTENT_SCHEMA_FILE: ${{ steps.non-existent-schema-file.outcome }}
        run: |
          function pick_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              *) echo "❓" ;;
            esac
          }
          
          # Flip results, failure -> success
          [ "$NON_EXISTENT_FILE" = "failure" ] && NON_EXISTENT_FILE="success"
          [ "$NON_EXISTENT_SCHEMA_FILE" = "failure" ] && NON_EXISTENT_SCHEMA_FILE="success"
          
          # Show results in GitHub step summary
          echo "$(pick_emoji $NON_EXISTENT_FILE) Non-existent file" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $NON_EXISTENT_SCHEMA_FILE) Non-existent schema file" >> $GITHUB_STEP_SUMMARY
          
          # Validate that all tests failed
          if [ "$NON_EXISTENT_FILE" != "success" ] || \
             [ "$NON_EXISTENT_SCHEMA_FILE" != "success" ]; then
            echo "::error::One or more tests did not fail as expected"
            exit 1
          fi

  test-url-exists-fails:
    name: Test Schema URL Failure Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false
      
      - name: Test Schema URL Not Reachable
        id: test-schema-url-not-reachable
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-url: https://example.com/non-existent-plus-ultra.schema.json
          
      - name: Collect results
        id: collect-results
        env:
          SCHEMA_URL_NOT_REACHABLE: ${{ steps.test-schema-url-not-reachable.outcome }}
        run: |
          function pick_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              *) echo "❓" ;;
            esac
          }
          
          # Flip results, failure -> success
          [ "$SCHEMA_URL_NOT_REACHABLE" = "failure" ] && SCHEMA_URL_NOT_REACHABLE="success"
          
          # Show results in GitHub step summary
          echo "$(pick_emoji $SCHEMA_URL_NOT_REACHABLE) Schema URL not reachable" >> $GITHUB_STEP_SUMMARY
          
          # Validate that all tests failed
          if [ "$SCHEMA_URL_NOT_REACHABLE" != "success" ]; then
            echo "::error::One or more tests did not fail as expected"
            exit 1
          fi

  test-schema-file-compatibility-fails:
    name: Test Schema and File Format Compatibility Failure Scenarios
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false
      
      # XML/XSD schema with JSON file
      - name: XML schema with JSON file
        id: xml-schema-json-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-file: test-files/xml/person.schema.xsd
      
      # XML/XSD schema with YAML file
      - name: XML schema with YAML file
        id: xml-schema-yaml-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/yaml/good_1.yaml
          schema-file: test-files/xml/person.schema.xsd
      
      # JSON schema with XML file
      - name: JSON schema with XML file
        id: json-schema-xml-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/xml/good_1.xml
          schema-file: test-files/json/person.schema.json
      
      # YAML schema with XML file
      - name: YAML schema with XML file
        id: yaml-schema-xml-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/xml/good_1.xml
          schema-file: test-files/yaml/person.schema.yaml
      
      # XML/XSD schema URL with JSON file
      - name: XML schema URL with JSON file
        id: xml-schema-url-json-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
          schema-url: https://raw.githubusercontent.com/chase-roohms/schema-validator/refs/heads/main/test-files/xml/person.schema.xsd
      
      # JSON schema URL with XML file
      - name: JSON schema URL with XML file
        id: json-schema-url-xml-file
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/xml/good_1.xml
          schema-url: https://raw.githubusercontent.com/chase-roohms/schema-validator/refs/heads/main/test-files/json/person.schema.json
      
      # XML/XSD schema with json file-format
      - name: XML schema with json file-format
        id: xml-schema-json-format
        uses: ./
        continue-on-error: true
        with:
          file-format: json
          schema-file: test-files/xml/person.schema.xsd
      
      # XML/XSD schema with yaml file-format
      - name: XML schema with yaml file-format
        id: xml-schema-yaml-format
        uses: ./
        continue-on-error: true
        with:
          file-format: yaml
          schema-file: test-files/xml/person.schema.xsd
      
      # JSON schema with xml file-format
      - name: JSON schema with xml file-format
        id: json-schema-xml-format
        uses: ./
        continue-on-error: true
        with:
          file-format: xml
          schema-file: test-files/json/person.schema.json
      
      # XML/XSD schema with 'all' file-format (includes json/yaml)
      - name: XML schema with all file-format
        id: xml-schema-all-format
        uses: ./
        continue-on-error: true
        with:
          file-format: all
          schema-file: test-files/xml/person.schema.xsd
      
      # JSON schema with 'all' file-format (includes xml)
      - name: JSON schema with all file-format
        id: json-schema-all-format
        uses: ./
        continue-on-error: true
        with:
          file-format: all
          schema-file: test-files/json/person.schema.json
      
      # Mixed files: JSON and XML with JSON schema
      - name: JSON schema with mixed JSON and XML files
        id: json-schema-mixed-files
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
            test-files/xml/good_1.xml
          schema-file: test-files/json/person.schema.json
      
      # Mixed files: JSON and XML with XML schema
      - name: XML schema with mixed JSON and XML files
        id: xml-schema-mixed-files
        uses: ./
        continue-on-error: true
        with:
          files: |
            test-files/json/good_1.json
            test-files/xml/good_1.xml
          schema-file: test-files/xml/person.schema.xsd
      
      - name: Collect results
        id: collect-results
        env:
          XML_SCHEMA_JSON_FILE: ${{ steps.xml-schema-json-file.outcome }}
          XML_SCHEMA_YAML_FILE: ${{ steps.xml-schema-yaml-file.outcome }}
          JSON_SCHEMA_XML_FILE: ${{ steps.json-schema-xml-file.outcome }}
          YAML_SCHEMA_XML_FILE: ${{ steps.yaml-schema-xml-file.outcome }}
          XML_SCHEMA_URL_JSON_FILE: ${{ steps.xml-schema-url-json-file.outcome }}
          JSON_SCHEMA_URL_XML_FILE: ${{ steps.json-schema-url-xml-file.outcome }}
          XML_SCHEMA_JSON_FORMAT: ${{ steps.xml-schema-json-format.outcome }}
          XML_SCHEMA_YAML_FORMAT: ${{ steps.xml-schema-yaml-format.outcome }}
          JSON_SCHEMA_XML_FORMAT: ${{ steps.json-schema-xml-format.outcome }}
          XML_SCHEMA_ALL_FORMAT: ${{ steps.xml-schema-all-format.outcome }}
          JSON_SCHEMA_ALL_FORMAT: ${{ steps.json-schema-all-format.outcome }}
          JSON_SCHEMA_MIXED_FILES: ${{ steps.json-schema-mixed-files.outcome }}
          XML_SCHEMA_MIXED_FILES: ${{ steps.xml-schema-mixed-files.outcome }}
        run: |
          function pick_emoji() {
            case "$1" in
              success) echo "✅" ;;
              failure) echo "❌" ;;
              *) echo "❓" ;;
            esac
          }

          # Flip results, failure -> success
          [ "$XML_SCHEMA_JSON_FILE" = "failure" ] && XML_SCHEMA_JSON_FILE="success"
          [ "$XML_SCHEMA_YAML_FILE" = "failure" ] && XML_SCHEMA_YAML_FILE="success"
          [ "$JSON_SCHEMA_XML_FILE" = "failure" ] && JSON_SCHEMA_XML_FILE="success"
          [ "$YAML_SCHEMA_XML_FILE" = "failure" ] && YAML_SCHEMA_XML_FILE="success"
          [ "$XML_SCHEMA_URL_JSON_FILE" = "failure" ] && XML_SCHEMA_URL_JSON_FILE="success"
          [ "$JSON_SCHEMA_URL_XML_FILE" = "failure" ] && JSON_SCHEMA_URL_XML_FILE="success"
          [ "$XML_SCHEMA_JSON_FORMAT" = "failure" ] && XML_SCHEMA_JSON_FORMAT="success"
          [ "$XML_SCHEMA_YAML_FORMAT" = "failure" ] && XML_SCHEMA_YAML_FORMAT="success"
          [ "$JSON_SCHEMA_XML_FORMAT" = "failure" ] && JSON_SCHEMA_XML_FORMAT="success"
          [ "$XML_SCHEMA_ALL_FORMAT" = "failure" ] && XML_SCHEMA_ALL_FORMAT="success"
          [ "$JSON_SCHEMA_ALL_FORMAT" = "failure" ] && JSON_SCHEMA_ALL_FORMAT="success"
          [ "$JSON_SCHEMA_MIXED_FILES" = "failure" ] && JSON_SCHEMA_MIXED_FILES="success"
          [ "$XML_SCHEMA_MIXED_FILES" = "failure" ] && XML_SCHEMA_MIXED_FILES="success"
          
          # Show results in GitHub step summary
          echo "## Schema/File Format Compatibility Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Individual File Tests" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_JSON_FILE) XML schema with JSON file" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_YAML_FILE) XML schema with YAML file" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $JSON_SCHEMA_XML_FILE) JSON schema with XML file" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $YAML_SCHEMA_XML_FILE) YAML schema with XML file" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Schema URL Tests" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_URL_JSON_FILE) XML schema URL with JSON file" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $JSON_SCHEMA_URL_XML_FILE) JSON schema URL with XML file" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Format Tests" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_JSON_FORMAT) XML schema with json file-format" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_YAML_FORMAT) XML schema with yaml file-format" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $JSON_SCHEMA_XML_FORMAT) JSON schema with xml file-format" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_ALL_FORMAT) XML schema with all file-format" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $JSON_SCHEMA_ALL_FORMAT) JSON schema with all file-format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Mixed File Tests" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $JSON_SCHEMA_MIXED_FILES) JSON schema with mixed JSON and XML files" >> $GITHUB_STEP_SUMMARY
          echo "$(pick_emoji $XML_SCHEMA_MIXED_FILES) XML schema with mixed JSON and XML files" >> $GITHUB_STEP_SUMMARY
          
          # Validate that all tests failed
          if [ "$XML_SCHEMA_JSON_FILE" != "success" ] || \
             [ "$XML_SCHEMA_YAML_FILE" != "success" ] || \
             [ "$JSON_SCHEMA_XML_FILE" != "success" ] || \
             [ "$YAML_SCHEMA_XML_FILE" != "success" ] || \
             [ "$XML_SCHEMA_URL_JSON_FILE" != "success" ] || \
             [ "$JSON_SCHEMA_URL_XML_FILE" != "success" ] || \
             [ "$XML_SCHEMA_JSON_FORMAT" != "success" ] || \
             [ "$XML_SCHEMA_YAML_FORMAT" != "success" ] || \
             [ "$JSON_SCHEMA_XML_FORMAT" != "success" ] || \
             [ "$XML_SCHEMA_ALL_FORMAT" != "success" ] || \
             [ "$JSON_SCHEMA_ALL_FORMAT" != "success" ] || \
             [ "$JSON_SCHEMA_MIXED_FILES" != "success" ] || \
             [ "$XML_SCHEMA_MIXED_FILES" != "success" ]; then
            echo "::error::One or more compatibility tests did not fail as expected"
            exit 1
          fi